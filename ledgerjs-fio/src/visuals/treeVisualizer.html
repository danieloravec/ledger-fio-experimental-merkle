<!DOCTYPE html>
<html>

<head>
    <title>Tree Visualization</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <div>
        <textarea id="jsonInput" placeholder="Paste JSON here"></textarea>
        <button onclick="visualizeTree()">Visualize Tree</button>
    </div>
    <canvas id="treeCanvas" height="10000px" style="border:1px solid red;"></canvas>
    <script>
        const Y_DELTA = 300;
        const TEXT_ROW_HEIGHT = 20;
        const DFS_BFS_ID_NO_VALUE = 0xffffffff;

        const canvas = document.getElementById('treeCanvas');
        canvas.width = window.innerWidth * 10;
        canvas.height = 10000;
        const ctx = canvas.getContext('2d');

        function drawTree(treeRepr, regionY, regionX1, regionX2, parentX, parentY) {
            if (!treeRepr) {
                return;
            }
            const textRows = [];

            const isCommandNode = treeRepr.bfsId.commandLevel != DFS_BFS_ID_NO_VALUE;
            if (isCommandNode) {
                textRows.push(...[
                    `DFS:`,
                    `  in: ${treeRepr.dfsId.inTime}`,
                    `  out: ${treeRepr.dfsId.outTime}`,
                ]);
                textRows.push(...[
                    `BFS:`,
                    `  level: ${treeRepr.bfsId.commandLevel}`,
                    `  seq: ${treeRepr.bfsId.levelSeqNumber}`,
                ]);
            }
            textRows.push(...[
                `HASH:`,
                `  ${treeRepr.hash.substring(0, 3)}..${treeRepr.hash.substring(treeRepr.hash.length - 3)}`,
            ]);
            const midX = (regionX1 + regionX2) / 2;
            for (let i = 0; i < textRows.length; i++) {
                ctx.fillText(textRows[i], midX, regionY + TEXT_ROW_HEIGHT * i, regionX2 - regionX1);
            }

            if (parentX && parentY) {
                ctx.beginPath();
                ctx.moveTo(parentX, parentY);
                ctx.lineTo(midX, regionY - TEXT_ROW_HEIGHT);
                ctx.stroke();
            }

            const regionWidth = regionX2 - regionX1;
            const textBottomY = regionY + TEXT_ROW_HEIGHT * textRows.length;
            if (isCommandNode) {
                // There is END_FOR to the left and right of us at least, so we can use a wider region for subtree
                drawTree(treeRepr.leftChild, regionY + Y_DELTA, Math.max(0, regionX1 - regionWidth), midX, midX, textBottomY);
                drawTree(treeRepr.rightChild, regionY + Y_DELTA, midX, Math.min(canvas.width, regionX2 + regionWidth), midX, textBottomY);
            } else {
                drawTree(treeRepr.leftChild, regionY + Y_DELTA, regionX1, midX, midX, textBottomY);
                drawTree(treeRepr.rightChild, regionY + Y_DELTA, midX, regionX2, midX, textBottomY);
            }
        }

        function visualizeTree() {
            const jsonInput = document.getElementById('jsonInput').value;
            const data = JSON.parse(jsonInput);
            drawTree(data, TEXT_ROW_HEIGHT, 0, canvas.width);
        }
    </script>
</body>

</html>